<VirtualHost *:80>
    ServerName wordcloud.simonrundell.com
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://wordcloud.simonrundell.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName wordcloud.simonrundell.com
    
    # SSL Configuration
    SSLEngine on
SSLCertificateFile /etc/letsencrypt/live/wordcloud.simonrundell.com/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/wordcloud.simonrundell.com/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
    
    # CORS headers for API
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"
    
    # Handle preflight OPTIONS requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Proxy all requests to Node.js app
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Increase timeout for image generation
    ProxyTimeout 60
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/wordcloud_error.log
    CustomLog ${APACHE_LOG_DIR}/wordcloud_access.log combined
    
    # Optional: Rate limiting (if mod_evasive is available)
    # DOSHashTableSize    2048
    # DOSPageCount        10
    # DOSPageInterval     1
    # DOSSiteCount        50
    # DOSSiteInterval     1
    # DOSBlockingPeriod   60
</VirtualHost>
